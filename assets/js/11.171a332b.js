(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{212:function(t,s,a){"use strict";a.r(s);var n=a(0),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"javascript-异步编程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#javascript-异步编程","aria-hidden":"true"}},[t._v("#")]),t._v(" JavaScript 异步编程")]),t._v(" "),a("p",[t._v("我们知道，无论是浏览器tab还是nodejs，默认情况下JavaScript通常都运行在一个进程中，\n采用了 单线程+ 事件循环的机制来执行浏览器相关的处理任务（"),a("router-link",{attrs:{to:"/tech/js/js-execution.html"}},[t._v("JavaScript Event Loop")]),t._v("）。")],1),t._v(" "),a("p",[t._v("程序执行过程中，所产生的处理任务(例如HTML解析， 交互响应等等)，会被依次加入到任务队列中。\n而Event Loop 则负责轮询并从队列中取出一个任务交给 JavaScript Engine执行。")]),t._v(" "),a("p",[t._v("JavaScript 的 Event Loop 机制保证了事件任务的按序执行，\n同时，Engine 每次只能执行一个任务，并保证只有在当前任务执行完毕后才会开始执行下一个任务。\n所以任务执行过程中对数据操作不会出现并发问题。")]),t._v(" "),a("p",[t._v("然而，采用串行的方式执行任务，会导致当遇到一个任务执行耗时特别长的时候，\n出现用户UI交互相关的任务无法得到及时处理的问题。\n举个"),a("a",{attrs:{href:"http://rauschma.github.io/async-examples/blocking.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("例子"),a("OutboundLink")],1),t._v("：")]),t._v(" "),a("div",{staticClass:"language-JS extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("a id"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"block"')]),t._v(" href"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("Block "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v(" seconds"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("a"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("p"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("button"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("This is a button"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("button"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("div id"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"statusMessage"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("div"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n    document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'block'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEventListener")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'click'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" onClick"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("onClick")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("event")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        event"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("preventDefault")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setStatusMessage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Blocking...'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 模拟一个需要执行5s的耗时任务")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sleep")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setStatusMessage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Done'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setStatusMessage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("msg")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'statusMessage'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("textContent "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sleep")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("milliseconds")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" start "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" start"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" milliseconds"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),a("p",[t._v("上面例子中，"),a("code",[t._v("setTimeout")]),t._v("会在任务队列中添加一个任务，sleep模拟了一个5s的耗时操作，\n在这个耗时任务执行完毕之前，用户的交互操作是无法被响应的。")]),t._v(" "),a("p",[t._v("为了避免UI响应被阻塞，我们的程序尽量不要在主线程中同步执行耗时操作。\n更好的做法是在主线程中将耗时操作任务交给子线程去异步执行，当任务执行完毕后再通知主线程获取任务结果。")]),t._v(" "),a("h2",{attrs:{id:"callback"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#callback","aria-hidden":"true"}},[t._v("#")]),t._v(" Callback")]),t._v(" "),a("p",[t._v("在ES6之前，对于异步执行结果的处理方式基本上都是通过注册事件监听（event）或者回调函数来完成的。")]),t._v(" "),a("p",[t._v("基本实现思想就是，主线程中发起异步任务的同时，通过回调函数的方式，指定异步任务执行完毕后，需要执行的任务。\n对于结果的处理通常会被封装在一个Callback函数中，当异步任务执行完毕，向事件队列中加入一个新的任务来执行Callback函数。")]),t._v(" "),a("p",[t._v("在大多数简单的业务场景下，使用这种方法非常方便，程序可读性也很好。\n然而一旦业务逻辑复杂起来，就会陷入"),a("code",[t._v("Callback Hell")]),t._v(": 程序中回调函数嵌套了回调函数，可维护性骤然下降。\n另外，如果程序还需要考虑到异常和错误的处理问题，使用Callback回调也比较繁琐。\n因为通常无法提供一个通用的异常处理回调，我们不得不去逐一判断异常类型，然后写很多错误处理函数。")]),t._v(" "),a("div",{staticClass:"tip custom-block"},[a("p",[t._v("将callback函数作为函数的入参，并在合适的时候回调的编程风格也被称为"),a("code",[t._v("Continuation-passing style")]),t._v("。")])]),t._v(" "),a("h2",{attrs:{id:"promise"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#promise","aria-hidden":"true"}},[t._v("#")]),t._v(" Promise")]),t._v(" "),a("p",[t._v("在程序逻辑复杂的情况下，由于函数嵌套层级过深导致程序可读性和可维护性下降，Callback相关的异步结果处理方式不够优雅。\n作为Callback的替代方案，ES6引入的"),a("code",[t._v("Promise")]),t._v("为调用方提供了处理异步操作结果的新姿势。\n(关于如何使用Promise的"),a("a",{attrs:{href:"http://es6.ruanyifeng.com/#docs/promise",target:"_blank",rel:"noopener noreferrer"}},[t._v("基础知识"),a("OutboundLink")],1),t._v(")")]),t._v(" "),a("p",[t._v("在程序控制流中，调用方通常并不关心异步任务的执行过程，而只负责发起任务和获取结果并处理；\n而异步任务则负责执行异步操作，并根据最终不同的结果状态（成功或失败）通知给调用方。")]),t._v(" "),a("p",[a("code",[t._v("Promise")]),t._v("的基本设计思路就是，使用"),a("code",[t._v("Promise")]),t._v("对象将异步任务部分的处理逻辑和结果封装起来，\n而"),a("code",[t._v("Promise")]),t._v("对象本身作为结果返回给调用方，调用方只需指定不同结果状态（成功或失败）后的处理流程即可。")]),t._v(" "),a("p",[t._v("这是一个很常见的“生产者-消费者”场景："),a("code",[t._v("Promise")]),t._v("负责产出和分发结果（成功或失败），调用方负责处理不同的结果。")]),t._v(" "),a("div",{staticClass:"language-JS extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" promise "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolve"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reject")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 异步操作发起")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 异步操作回调")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 异步操作成功 */")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 分发成功结果")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("reject")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 分发失败结果")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 调用方")]),t._v("\npromise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 处理成功结果")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 处理失败结果")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[a("img",{attrs:{src:"/javascript/js-async/promise-constructor.png",alt:""}})]),t._v(" "),a("p",[t._v("当我们通过"),a("code",[t._v("Promise")]),t._v("来封装一个异步结果，这意味着"),a("code",[t._v("Promise")]),t._v("对象处于三种状态的一种：")]),t._v(" "),a("ul",[a("li",[t._v("Pending: 异步任务还未执行完毕")]),t._v(" "),a("li",[t._v("Fulfilled: 异步任务执行成功")]),t._v(" "),a("li",[t._v("Rejected: 异步任务执行失败")])]),t._v(" "),a("p",[t._v("从时序上来讲，当异步任务执行完毕，根据结果的不同，通过调用"),a("code",[t._v("resolve")]),t._v("或"),a("code",[t._v("reject")]),t._v("函数，\n"),a("code",[t._v("Promise")]),t._v("的状态从Pending切换到Fulfilled或Rejected，且这个状态切换是单向不可逆的。")]),t._v(" "),a("p",[t._v("一旦状态发生切换，就会通知给调用方（消费者）执行对应的后续操作，因此，这个状态时序的保证是"),a("code",[t._v("Promise")]),t._v("能够处理异步流程的关键。")]),t._v(" "),a("h3",{attrs:{id:"链式调用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#链式调用","aria-hidden":"true"}},[t._v("#")]),t._v(" 链式调用")]),t._v(" "),a("p",[a("code",[t._v("then()")]),t._v("方法挂载在"),a("code",[t._v("Promise")]),t._v("原型对象上，用来让调用方来指定对于不同状态的返回结果该如何处理：\n"),a("img",{attrs:{src:"/javascript/js-async/promise-then.png",alt:""}})]),t._v(" "),a("p",[a("code",[t._v("onFulfilled")]),t._v("和"),a("code",[t._v("onRejectd")]),t._v("函数分别处理了"),a("code",[t._v("fulfilled")]),t._v("和"),a("code",[t._v("rejected")]),t._v("两种状态的回调。\n同时，"),a("code",[t._v("then")]),t._v("方法也返回了一个新的promise对象，它可以让调用方使用链式调用的方式继续处理业务逻辑。")]),t._v(" "),a("p",[t._v("那这个新的promise对象的状态是什么样的呢？假定promise对象P，它的then方法新返回的promise对象是Q，\nQ的状态由P的"),a("code",[t._v("onFulfilled")]),t._v("和"),a("code",[t._v("onRejectd")]),t._v("函数的执行决定：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("p"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" a\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" c\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" b；\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("val")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// val is a or b")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 捕获onFulfilled和onRejectd的返回结果")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("error2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// error2 is c")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 捕获onFulfilled和onRejectd执行过程中的异常")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("可以看到，只要是"),a("code",[t._v("onFulfilled")]),t._v("和"),a("code",[t._v("onRejectd")]),t._v("函数正常返回的值（例如a，b）都会被Q的"),a("code",[t._v("onFulfilled")]),t._v("捕获执行；\n如果执行过程中发生了异常，则会被Q的"),a("code",[t._v("onRejectd")]),t._v("捕获到。")]),t._v(" "),a("p",[t._v("还有一种情况需要单独拉出来说明一下，如果P的"),a("code",[t._v("onFulfilled")]),t._v("方法中返回了一个promise对象，那么这个promise对象就会被作为then方法的返回对象Q。\n这样的机制有助于把promise的嵌套调用扁平化，避免出现callback那种嵌套地狱。")]),t._v(" "),a("p",[t._v("虽然"),a("code",[t._v("Promise")]),t._v("的出现改进了回调的嵌套问题，\n尽管如此，一堆then方法的链式调用仍然显得代码冗余，可读性仍然有待提高。\n使用ES6的Generator + Promise 的方式可以让我们写出更符合直觉的代码逻辑（线性的执行），配合流程管理模块，让代码能够自动地执行。\n而ES7中更是将这一机制变成了async 函数来使用。")]),t._v(" "),a("h2",{attrs:{id:"async-函数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#async-函数","aria-hidden":"true"}},[t._v("#")]),t._v(" async 函数")]),t._v(" "),a("p",[t._v("ES7引入的"),a("code",[t._v("async")]),t._v("关键字让我们在异步编程的过程中更加方便的使用"),a("code",[t._v("Promise")]),t._v(",\n它用于将一个函数声明为异步函数，表示当前函数中可能有耗时操作，需要异步执行。")]),t._v(" "),a("p",[t._v("async 函数的返回值是一个promise对象，这个对象P在异步函数执行之初就被创建了出来。\n异步函数执行过程中，"),a("code",[t._v("return")]),t._v("和"),a("code",[t._v("throw")]),t._v("操作都会使函数停止执行立即返回：")]),t._v(" "),a("ul",[a("li",[t._v("异步函数 return 一个普通值x(非Promise对象)，则异步函数的返回结果为"),a("code",[t._v("Promise<x>")]),t._v(",状态为fulfilled；")]),t._v(" "),a("li",[t._v("异步函数 return 一个新的Promise Q， 则异步函数的返回结果为Q；")]),t._v(" "),a("li",[t._v("异步函数 throw 一个error 则返回一个状态为rejected的"),a("code",[t._v("Promise<err>")])])]),t._v(" "),a("h3",{attrs:{id:"await-操作符"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#await-操作符","aria-hidden":"true"}},[t._v("#")]),t._v(" await 操作符")]),t._v(" "),a("p",[t._v("await 操作符通常会和async函数一起搭配使用，用来同步获取一个Promise对象的执行结果, 它比"),a("code",[t._v("yeild")]),t._v("具有更好的语义。\n由于await 操作会阻塞当前操作，因此必须放在async 函数中使用。")]),t._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结","aria-hidden":"true"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("p",[t._v("我们可以看到，如何解决异步结果分发和处理是JavaScript的异步编程中的核心问题。\n搭配 Promise 与 async 函数 我们不仅可以写出更加符合直觉的代码逻辑，同时还能更优雅地处理异常操作。")])])}),[],!1,null,null,null);s.default=e.exports}}]);