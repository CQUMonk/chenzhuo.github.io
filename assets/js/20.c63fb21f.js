(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{224:function(t,a,s){"use strict";s.r(a);var n=s(0),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"javascript-中的元编程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#javascript-中的元编程","aria-hidden":"true"}},[t._v("#")]),t._v(" JavaScript 中的元编程")]),t._v(" "),s("h2",{attrs:{id:"元编程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#元编程","aria-hidden":"true"}},[t._v("#")]),t._v(" 元编程")]),t._v(" "),s("p",[t._v("在日常业务开发过程中，我们的代码接收并处理用户的输入，实现对应业务逻辑，然后对响应给用户，这也是我们通常意义上说的业务程序。")]),t._v(" "),s("p",[t._v("而所谓"),s("code",[t._v("元编程(meta programming)")]),t._v("，就是能够操作代码的代码。说的更直接一点，也就是让我们的代码在运行过程中有能力来访问和操作程序所定义的类、对象、函数和变量等等。")]),t._v(" "),s("p",[t._v("抛开具体实现方式来讨论，我们通常认为一门编程语言的"),s("code",[t._v("元编程")]),t._v("能力主要包括以下三个方面：")]),t._v(" "),s("ul",[s("li",[t._v("自省(Introspection): 读取程序对象数据信息的能力，例如程序本身的结构等等。")]),t._v(" "),s("li",[t._v("自举(Self-modification):动态修改程序自身对象的能力，例如动态地为某个对象增加一个属性。")]),t._v(" "),s("li",[t._v("代理(Intercession)：动态代理或者自定义对象原有行为的能力。")])]),t._v(" "),s("p",[t._v("不同编程语言的"),s("code",[t._v("元编程")]),t._v("能力差异很大，对上面所说的三个方面支持程度和实现方式也大不相同，例如java提供了反射机制，C++采用了模板等等。\n"),s("code",[t._v("JavaScript")]),t._v("的对象体系自身具有高度的动态性，我们很多日常用到的"),s("code",[t._v("Object")]),t._v("API对于对象的操作实质上都属于元编程的范畴。")]),t._v(" "),s("h2",{attrs:{id:"_2-proxy"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-proxy","aria-hidden":"true"}},[t._v("#")]),t._v(" 2. Proxy")]),t._v(" "),s("p",[t._v("ES6 新引入的 "),s("code",[t._v("Proxy")]),t._v(" 为JavaScript提供了运行阶段重新定义对象默认行为的能力，也就是上面说到的"),s("code",[t._v("Intercession")]),t._v("。\n通过"),s("code",[t._v("Proxy")]),t._v("，我们可以拦截到外部对于该对象的访问和操作，这种机制为我们提供了重新定义对象上的各种默认行为的能力。")]),t._v(" "),s("p",[s("code",[t._v("Proxy")]),t._v("构造函数可以创建一个对象的proxy实例，它接收两个参数：")]),t._v(" "),s("div",{staticClass:"language-JS extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" objProxy"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Proxy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  target"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" \n  handler \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("ul",[s("li",[t._v("target： proxy 所要拦截和代理的目标对象")]),t._v(" "),s("li",[t._v("handler：对目标对象每个具体的操作，handler对象中都对应了一个具体的操作方法(trap)，覆写该方法就可以重新定义该操作")])]),t._v(" "),s("p",[t._v("更多关于如何使用Proxy的知识可以参考"),s("a",{attrs:{href:"http://es6.ruanyifeng.com/#docs/proxy",target:"_blank",rel:"noopener noreferrer"}},[t._v("ECMAScript6 Proxy"),s("OutboundLink")],1)]),t._v(" "),s("h2",{attrs:{id:"_3-设计思想"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-设计思想","aria-hidden":"true"}},[t._v("#")]),t._v(" 3. 设计思想")]),t._v(" "),s("h3",{attrs:{id:"_3-1-分层：将业务编程和元编程分离"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-分层：将业务编程和元编程分离","aria-hidden":"true"}},[t._v("#")]),t._v(" 3.1 分层：将业务编程和元编程分离")]),t._v(" "),s("p",[t._v("JavaScript中，元编程和通用业务编程在语法和API调用方面并没有很明显的使用界限。\n举个例子：")]),t._v(" "),s("div",{staticClass:"language-JS extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" object1 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("a"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("object1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("hasOwnProperty")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'a'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// expected output: true")]),t._v("\n")])])]),s("p",[s("code",[t._v("hasOwnProperty")]),t._v("方法可以判断对象中是否具有指定的属性，这在分类上明显是属于元编程层面上的API。\n在JavaScript的业务代码中我们可以像对象本身的方法一样很方便的调用。")]),t._v(" "),s("p",[t._v("问题在于，如果业务编程和元编程操作不加以区分，让业务代码中可以轻易地访问到这类API就有可能埋下意外Bug, 举个例子：")]),t._v(" "),s("div",{staticClass:"language-JS extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("object1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("hasOwnProperty"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("object1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("hasOwnProperty")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'a'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//Error: object1.hasOwnProperty is not a function")]),t._v("\n")])])]),s("p",[t._v("这里"),s("code",[t._v("object1")]),t._v("对象的"),s("code",[t._v("hasOwnProperty")]),t._v("方法被显式地置为null，后续的调用就会报错。")]),t._v(" "),s("p",[t._v("为了规避这种情况的出现，Proxy 在设计上刻意地将业务层面的API和元编程层面的API作了区分和隔离，元编程层面的操作都封装到了"),s("code",[t._v("Handler")]),t._v("中，而暴露给业务代码层面的只是"),s("code",[t._v("Proxy")]),t._v("对象，避免了上述这种问题。")]),t._v(" "),s("h3",{attrs:{id:"_3-2-代理对象与操作拦截"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-代理对象与操作拦截","aria-hidden":"true"}},[t._v("#")]),t._v(" 3.2 代理对象与操作拦截")]),t._v(" "),s("p",[t._v("在设计原则上，"),s("code",[t._v("Proxy")]),t._v("对于target对象的封装是完全透明的：我们无法直接判断一个对象是否是一个"),s("code",[t._v("Proxy")]),t._v("对象。\n另外，我们也无法直接访问到一个"),s("code",[t._v("Proxy")]),t._v("对象的handler方法。")]),t._v(" "),s("p",[t._v("如果我们想知道一个对象是否被代理掉，只得自己去实现相应的记录操作:统一创建、记录和维护。")]),t._v(" "),s("p",[t._v("通常情况下，"),s("code",[t._v("Proxy")]),t._v("的应用场景可以分为两类：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("作为target对象的封装器:\n一个非常简易的“代理模式”，通过拦截对target的访问操作，来改变target对象的原有行为。")])]),t._v(" "),s("li",[s("p",[t._v("将Proxy对象当做一个"),s("code",[t._v("虚拟对象")]),t._v("来使用：\n这种场景下，target对象本身只是为了创建proxy对象。 在proxy对象的handler中定义了一些特定的行为操作，当外部调用这些操作的时候，会被拦截并执行对应的操作。被封装的target对象对于这些特殊的操作是完全无感知的。")])])]),t._v(" "),s("h3",{attrs:{id:"_3-3-元对象协议"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-元对象协议","aria-hidden":"true"}},[t._v("#")]),t._v(" 3.3 元对象协议")]),t._v(" "),s("p",[t._v("ECMAScript规范中规定了JavaScript是如何执行的，这其中包括了如何操作对象的协议 —— "),s("code",[t._v("元对象协议（MOP）")]),t._v("。\n协议中定义了能够在对象上进行的操作，以及执行这些操作的规则。\n更具体一点，MOP定义了13个最基础的"),s("a",{attrs:{href:"https://tc39.es/ecma262/#sec-invariants-of-the-essential-internal-methods",target:"_blank",rel:"noopener noreferrer"}},[t._v("内置方法（internal method）"),s("OutboundLink")],1),t._v("：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("GetPrototypeOf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("SetPrototypeOf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("V")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("IsExtensible"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("PreventExtensions"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("GetOwnProperty"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("P")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("DefineOwnProperty"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("P")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Desc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("HasProperty"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("P")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Get"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("P")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Receiver"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Set"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("P")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("V")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Receiver"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Delete"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("P")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("OwnPropertyKeys"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Call"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Construct"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("我们对于一个对象进行任意的操作，都会被转换为这些内置方法的执行。")]),t._v(" "),s("p",[t._v("事实上，Proxy之所以具有重新定义对象默认行为的能力，就是因为JavaScript引擎允许使用handler中的trap来自定义内置方法。\nhandler中可以被覆写的trap与上述的内置方法一一对应。")]),t._v(" "),s("p",[t._v("在保持灵活性的同时，为了避免由于滥用内置方法产生不可预知的Bug，\nES标准规范也设定了一系列的"),s("a",{attrs:{href:"https://tc39.es/ecma262/#sec-invariants-of-the-essential-internal-methods",target:"_blank",rel:"noopener noreferrer"}},[t._v("限制"),s("OutboundLink")],1),t._v("，例如限制函数的返回值类型等等。")]),t._v(" "),s("h2",{attrs:{id:"reflect"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#reflect","aria-hidden":"true"}},[t._v("#")]),t._v(" Reflect")]),t._v(" "),s("p",[t._v("在实际使用过程中，我们很多场景都是希望Hook到target对象的某些操作，在不改变target对象默认行为的情况下，自定义一些额外的操作。\n这个时候"),s("a",{attrs:{href:"http://es6.ruanyifeng.com/#docs/reflect",target:"_blank",rel:"noopener noreferrer"}},[t._v("Reflect"),s("OutboundLink")],1),t._v("对象所提供的API就非常有用了.")]),t._v(" "),s("p",[s("code",[t._v("Reflect")]),t._v("对象提供的13个静态方法和"),s("code",[t._v("Proxy")]),t._v("实例中的13个trap一一对应， 它保留了对应trap的默认行为。")]),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结","aria-hidden":"true"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("JavaScript在先前的设计中并没有将业务与元编程层面的API进行隔离，\n我们在编写业务层面的代码时也常常会使用JavaScript在自省和自举的动态方面的能力。\n而对于动态地Hook掉对象的方法这种操作，往往会在框架开发中使用的比较频繁。")])])}),[],!1,null,null,null);a.default=e.exports}}]);